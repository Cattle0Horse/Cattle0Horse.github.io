<!doctype html><html lang=en><head><meta charset=utf-8><meta name=generator content="Hugo 0.145.0"><meta http-equiv=X-UA-Compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1"><meta name=author content><meta property="og:url" content="https://cattle0horse.github.io/posts/rate-limiter/"><link rel=canonical href=https://cattle0horse.github.io/posts/rate-limiter/><link rel=apple-touch-icon href=/logo.png><link rel=icon href=/logo.png><link rel=shortcut href=/logo.png><link rel=alternate type=application/atom+xml href=https://cattle0horse.github.io/index.xml title="CattleHorse's Blog"><script type=application/ld+json>{"@context":"http://schema.org","@type":"BlogPosting","mainEntityOfPage":{"@type":"WebPage","@id":"https:\/\/cattle0horse.github.io\/"},"articleSection":"posts","name":"限流初识","headline":"限流初识","description":"为什么需要限流 避免连锁崩溃 一个服务即便进行过压测，但当真实运行到线上时，其收到的请求流量以及能够负载的流量是不固定的，如果服务自身没有一个自我保护机制，当流量超过预计的负载后，会将这部分负载传递给该服务的下游，造成连锁反应甚至雪崩。\n提供可靠的响应时间 服务调用方一般都设有超时时间，如果一个服务由于拥塞，导致响应时间都处于超时状态，那么即便服务最终正确提供了响应，对于 Client 来说也完全没有意义。\n一个服务对于调用方提供的承诺既包含了响应的结果，也包含了响应的时间。限流能够让服务自身通过主动丢弃负载能力外的流量，以达到在额定负载能力下，依然能够维持有效的响应效率。\n限流方案 固定窗口计数器（Fixed Window Counter） 原理：在固定的时间窗口内，允许一定数量的请求通过。每当时间窗口结束时，计数器会重置。超出最大请求数的请求将被拒绝。 特点： 容易受到时间窗口边界问题的影响（即在窗口切换时，可能会允许过多的请求通过） 适用场景：适用于流量相对平稳的场景，通常在请求量较低的应用中使用。 具体来说，当大量请求在一个窗口的特别早或特别晚时，就会出现“突刺”现象。太早则窗口剩余时间无法处理；太晚则可能和下一个窗口的大量请求堆积，导致超出阈值。\n例如在 1 分钟内，5 个请求都是在前 30s 过来的，那么后面的 30s 的请求都会被拒绝，而系统此时是空闲的。另外还有“临界问题”，如果 5 个请求是在后 30s 过来的，而下一个 1 分钟的 5 个请求在前 30s 过来，此时系统在这 1 分钟内就需要处理 200 个请求，跟我们想要的不符合。\ntype FixedWindowCounter struct { mu sync.Mutex requestCount int limit int window time.Duration resetTime time.Time } func NewFixedWindowCounter(limit int, window time.Duration) *FixedWindowCounter { return \u0026amp;FixedWindowCounter{ limit: limit, window: window, resetTime: time.Now(), } } func (fw *FixedWindowCounter) Allow() bool { fw.mu.Lock() defer fw.mu.Unlock() now := time.Now() \/\/ 如果距离上次重置时间大于窗口值，则重置计数器 if now.Sub(fw.resetTime) \u0026gt;= fw.window { fw.requestCount = 0 fw.resetTime = now } if fw.requestCount \u0026lt; fw.limit { fw.requestCount\u002b\u002b return true } return false } 滑动窗口日志（Sliding Window Log） 原理：每次请求都会在时间轴上记录，滑动窗口会随着时间的推移进行更新。 特点： 能够更加平滑地控制请求速率，避免固定窗口切换时的突发流量 其消耗的内存过多，因为即使一个请求已被拒绝，它的时间戳依然被保存在内存中。 适用场景：适用于需要精确限流的场景，减少边界效应。 ","inLanguage":"en-US","author":"","creator":"","publisher":"","accountablePerson":"","copyrightHolder":"","copyrightYear":"2025","datePublished":"2025-07-10 00:00:00 \u002b0000 UTC","dateModified":"2025-07-10 00:00:00 \u002b0000 UTC","url":"https:\/\/cattle0horse.github.io\/posts\/rate-limiter\/","keywords":["系统设计"]}</script><title>限流初识</title>
<meta property="og:title" content="限流初识"><meta property="og:type" content="article"><meta property="og:description" content="为什么需要限流 避免连锁崩溃 一个服务即便进行过压测，但当真实运行到线上时，其收到的请求流量以及能够负载的流量是不固定的，如果服务自身没有一个自我保护机制，当流量超过预计的负载后，会将这部分负载传递给该服务的下游，造成连锁反应甚至雪崩。
提供可靠的响应时间 服务调用方一般都设有超时时间，如果一个服务由于拥塞，导致响应时间都处于超时状态，那么即便服务最终正确提供了响应，对于 Client 来说也完全没有意义。
一个服务对于调用方提供的承诺既包含了响应的结果，也包含了响应的时间。限流能够让服务自身通过主动丢弃负载能力外的流量，以达到在额定负载能力下，依然能够维持有效的响应效率。
限流方案 固定窗口计数器（Fixed Window Counter） 原理：在固定的时间窗口内，允许一定数量的请求通过。每当时间窗口结束时，计数器会重置。超出最大请求数的请求将被拒绝。 特点： 容易受到时间窗口边界问题的影响（即在窗口切换时，可能会允许过多的请求通过） 适用场景：适用于流量相对平稳的场景，通常在请求量较低的应用中使用。 具体来说，当大量请求在一个窗口的特别早或特别晚时，就会出现“突刺”现象。太早则窗口剩余时间无法处理；太晚则可能和下一个窗口的大量请求堆积，导致超出阈值。
例如在 1 分钟内，5 个请求都是在前 30s 过来的，那么后面的 30s 的请求都会被拒绝，而系统此时是空闲的。另外还有“临界问题”，如果 5 个请求是在后 30s 过来的，而下一个 1 分钟的 5 个请求在前 30s 过来，此时系统在这 1 分钟内就需要处理 200 个请求，跟我们想要的不符合。
type FixedWindowCounter struct { mu sync.Mutex requestCount int limit int window time.Duration resetTime time.Time } func NewFixedWindowCounter(limit int, window time.Duration) *FixedWindowCounter { return &amp;FixedWindowCounter{ limit: limit, window: window, resetTime: time.Now(), } } func (fw *FixedWindowCounter) Allow() bool { fw.mu.Lock() defer fw.mu.Unlock() now := time.Now() // 如果距离上次重置时间大于窗口值，则重置计数器 if now.Sub(fw.resetTime) >= fw.window { fw.requestCount = 0 fw.resetTime = now } if fw.requestCount < fw.limit { fw.requestCount++ return true } return false } 滑动窗口日志（Sliding Window Log） 原理：每次请求都会在时间轴上记录，滑动窗口会随着时间的推移进行更新。 特点： 能够更加平滑地控制请求速率，避免固定窗口切换时的突发流量 其消耗的内存过多，因为即使一个请求已被拒绝，它的时间戳依然被保存在内存中。 适用场景：适用于需要精确限流的场景，减少边界效应。 "><meta name=description content="为什么需要限流 避免连锁崩溃 一个服务即便进行过压测，但当真实运行到线上时，其收到的请求流量以及能够负载的流量是不固定的，如果服务自身没有一个自我保护机制，当流量超过预计的负载后，会将这部分负载传递给该服务的下游，造成连锁反应甚至雪崩。
提供可靠的响应时间 服务调用方一般都设有超时时间，如果一个服务由于拥塞，导致响应时间都处于超时状态，那么即便服务最终正确提供了响应，对于 Client 来说也完全没有意义。
一个服务对于调用方提供的承诺既包含了响应的结果，也包含了响应的时间。限流能够让服务自身通过主动丢弃负载能力外的流量，以达到在额定负载能力下，依然能够维持有效的响应效率。
限流方案 固定窗口计数器（Fixed Window Counter） 原理：在固定的时间窗口内，允许一定数量的请求通过。每当时间窗口结束时，计数器会重置。超出最大请求数的请求将被拒绝。 特点： 容易受到时间窗口边界问题的影响（即在窗口切换时，可能会允许过多的请求通过） 适用场景：适用于流量相对平稳的场景，通常在请求量较低的应用中使用。 具体来说，当大量请求在一个窗口的特别早或特别晚时，就会出现“突刺”现象。太早则窗口剩余时间无法处理；太晚则可能和下一个窗口的大量请求堆积，导致超出阈值。
例如在 1 分钟内，5 个请求都是在前 30s 过来的，那么后面的 30s 的请求都会被拒绝，而系统此时是空闲的。另外还有“临界问题”，如果 5 个请求是在后 30s 过来的，而下一个 1 分钟的 5 个请求在前 30s 过来，此时系统在这 1 分钟内就需要处理 200 个请求，跟我们想要的不符合。
type FixedWindowCounter struct { mu sync.Mutex requestCount int limit int window time.Duration resetTime time.Time } func NewFixedWindowCounter(limit int, window time.Duration) *FixedWindowCounter { return &amp;FixedWindowCounter{ limit: limit, window: window, resetTime: time.Now(), } } func (fw *FixedWindowCounter) Allow() bool { fw.mu.Lock() defer fw.mu.Unlock() now := time.Now() // 如果距离上次重置时间大于窗口值，则重置计数器 if now.Sub(fw.resetTime) >= fw.window { fw.requestCount = 0 fw.resetTime = now } if fw.requestCount < fw.limit { fw.requestCount++ return true } return false } 滑动窗口日志（Sliding Window Log） 原理：每次请求都会在时间轴上记录，滑动窗口会随着时间的推移进行更新。 特点： 能够更加平滑地控制请求速率，避免固定窗口切换时的突发流量 其消耗的内存过多，因为即使一个请求已被拒绝，它的时间戳依然被保存在内存中。 适用场景：适用于需要精确限流的场景，减少边界效应。 "><meta property="og:locale" content="cn"><meta property="og:image" content="/logo.png"><style>body{font-family:lxgw wenkai,sans-serif;font-weight:400;-webkit-font-smoothing:antialiased;margin:0 20px;background-color:#f8f9fa}article{max-width:800px;margin-left:auto;margin-right:auto}a{color:#000;text-decoration:none}a:hover{font-weight:600;text-decoration:underline}.post-ads{margin:50px 0}.markdown-body{font-size:18px;max-width:100%}.markdown-body a{text-decoration:underline;text-decoration-color:#000}.markdown-body blockquote{margin:0;padding:0 1em;color:#57606a;border-left:.25em solid #d0d7de}.markdown-body pre{padding:16px;overflow:auto;border-radius:10px;font-family:fira code,monospace}.markdown-body code{padding:.2em .4em;font-size:85%;background-color:#e9ecef;border-radius:6px;font-family:fira code,monospace}.markdown-body pre>code{padding:0;font-size:100%;background-color:inherit;border:0;font-family:fira code,monospace}.Chinese .markdown-body{line-height:200%}.site-date-catalog{font-size:2rem}.header-title{font-size:2rem;font-weight:700;margin-top:32px;font-family:bungee shade,sans-serif}.header-title a{text-decoration:none}.header-subtitle{color:#666}.header-items{margin:10px 0}.header-item{margin:0 5px;font-weight:700}.header-line{width:100%;border-width:2px;border-color:#482936;border-style:solid none none none}.lang-switch{font-weight:600}#posts-list{min-height:600px}.posts-line{font-size:1.2rem;margin:12px 0}.posts-categories{font-size:.8rem;margin:auto;text-align:center}.posts-category{padding:3px 0;border:#000 2px solid;border-radius:5px}.site-footer{font-size:12px;text-align:center;padding:40px 24px;color:#868e96;display:flex;justify-content:center;align-items:center}.site-footer-item{margin-right:12px}.post-header{margin-bottom:50px}.post-title{font-size:2rem;font-weight:600}.post-tags{display:inline;font-weight:600;padding:2px 5px;margin-right:6px;border:#000 2px solid;border-radius:5px}.post-date{font-weight:800;font-style:italic}.post-author{float:right;font-weight:600}.page-content{min-height:60%}.post-content{margin-bottom:50px}.post-content p{hyphens:auto;line-height:1.8;text-justify:ideographic;margin-bottom:1em}.post-content img{max-width:100%;display:block;margin-right:auto;margin-top:6px}.post-content .post-gallery{display:flex;flex-wrap:wrap;gap:6px}.post-content .post-gallery img{margin-right:auto;margin-top:auto;width:calc(50% - 3px)}.related-content{border-width:3px;border-style:solid;border-color:#333;padding:0 10px;margin-bottom:50px;margin-top:100px}.related-content li{margin:5px 0}.taxonomy-term{font-size:3rem}.gallery-img{text-align:center}.gallery-img span{text-align:center}.gallery-img-desc{font-size:.8em;font-weight:800}#disqus_thread{position:relative}#disqus_thread:after{content:"";display:block;height:55px;width:100%;position:absolute;bottom:0;background:#fff}@media screen and (max-width:600px){.posts-line{font-size:16px}.markdown-body{font-size:16px}.post-title{font-size:2rem}.post-content p{letter-spacing:.05em}.post-content .post-gallery img{width:100%}}@media screen and (max-width:48em){.posts-category{display:none}}</style><style>.container,.container-fluid{margin-right:auto;margin-left:auto}.container-fluid{padding-right:2rem;padding-left:2rem}.row{box-sizing:border-box;display:-webkit-box;display:-ms-flexbox;display:flex;-webkit-box-flex:0;-ms-flex:0 1 auto;flex:initial;-webkit-box-orient:horizontal;-webkit-box-direction:normal;-ms-flex-direction:row;flex-direction:row;-ms-flex-wrap:wrap;flex-wrap:wrap;margin-right:-.5rem;margin-left:-.5rem}.row.reverse{-webkit-box-orient:horizontal;-webkit-box-direction:reverse;-ms-flex-direction:row-reverse;flex-direction:row-reverse}.col.reverse{-webkit-box-orient:vertical;-webkit-box-direction:reverse;-ms-flex-direction:column-reverse;flex-direction:column-reverse}.col-xs,.col-xs-1,.col-xs-10,.col-xs-11,.col-xs-12,.col-xs-2,.col-xs-3,.col-xs-4,.col-xs-5,.col-xs-6,.col-xs-7,.col-xs-8,.col-xs-9,.col-xs-offset-0,.col-xs-offset-1,.col-xs-offset-10,.col-xs-offset-11,.col-xs-offset-12,.col-xs-offset-2,.col-xs-offset-3,.col-xs-offset-4,.col-xs-offset-5,.col-xs-offset-6,.col-xs-offset-7,.col-xs-offset-8,.col-xs-offset-9{box-sizing:border-box;-webkit-box-flex:0;-ms-flex:0 0 auto;flex:none;padding-right:.5rem;padding-left:.5rem}.col-xs{-webkit-box-flex:1;-ms-flex-positive:1;flex-grow:1;-ms-flex-preferred-size:0;flex-basis:0;max-width:100%}.col-xs-1{-ms-flex-preferred-size:8.33333333%;flex-basis:8.33333333%;max-width:8.33333333%}.col-xs-2{-ms-flex-preferred-size:16.66666667%;flex-basis:16.66666667%;max-width:16.66666667%}.col-xs-3{-ms-flex-preferred-size:25%;flex-basis:25%;max-width:25%}.col-xs-4{-ms-flex-preferred-size:33.33333333%;flex-basis:33.33333333%;max-width:33.33333333%}.col-xs-5{-ms-flex-preferred-size:41.66666667%;flex-basis:41.66666667%;max-width:41.66666667%}.col-xs-6{-ms-flex-preferred-size:50%;flex-basis:50%;max-width:50%}.col-xs-7{-ms-flex-preferred-size:58.33333333%;flex-basis:58.33333333%;max-width:58.33333333%}.col-xs-8{-ms-flex-preferred-size:66.66666667%;flex-basis:66.66666667%;max-width:66.66666667%}.col-xs-9{-ms-flex-preferred-size:75%;flex-basis:75%;max-width:75%}.col-xs-10{-ms-flex-preferred-size:83.33333333%;flex-basis:83.33333333%;max-width:83.33333333%}.col-xs-11{-ms-flex-preferred-size:91.66666667%;flex-basis:91.66666667%;max-width:91.66666667%}.col-xs-12{-ms-flex-preferred-size:100%;flex-basis:100%;max-width:100%}.col-xs-offset-0{margin-left:0}.col-xs-offset-1{margin-left:8.33333333%}.col-xs-offset-2{margin-left:16.66666667%}.col-xs-offset-3{margin-left:25%}.col-xs-offset-4{margin-left:33.33333333%}.col-xs-offset-5{margin-left:41.66666667%}.col-xs-offset-6{margin-left:50%}.col-xs-offset-7{margin-left:58.33333333%}.col-xs-offset-8{margin-left:66.66666667%}.col-xs-offset-9{margin-left:75%}.col-xs-offset-10{margin-left:83.33333333%}.col-xs-offset-11{margin-left:91.66666667%}.start-xs{-webkit-box-pack:start;-ms-flex-pack:start;justify-content:flex-start;text-align:start}.center-xs{-webkit-box-pack:center;-ms-flex-pack:center;justify-content:center;text-align:center}.end-xs{-webkit-box-pack:end;-ms-flex-pack:end;justify-content:flex-end;text-align:end}.top-xs{-webkit-box-align:start;-ms-flex-align:start;align-items:flex-start}.middle-xs{-webkit-box-align:center;-ms-flex-align:center;align-items:center}.bottom-xs{-webkit-box-align:end;-ms-flex-align:end;align-items:flex-end}.around-xs{-ms-flex-pack:distribute;justify-content:space-around}.between-xs{-webkit-box-pack:justify;-ms-flex-pack:justify;justify-content:space-between}.first-xs{-webkit-box-ordinal-group:0;-ms-flex-order:-1;order:-1}.last-xs{-webkit-box-ordinal-group:2;-ms-flex-order:1;order:1}@media only screen and (min-width:48em){.container{width:49rem}.col-sm,.col-sm-1,.col-sm-10,.col-sm-11,.col-sm-12,.col-sm-2,.col-sm-3,.col-sm-4,.col-sm-5,.col-sm-6,.col-sm-7,.col-sm-8,.col-sm-9,.col-sm-offset-0,.col-sm-offset-1,.col-sm-offset-10,.col-sm-offset-11,.col-sm-offset-12,.col-sm-offset-2,.col-sm-offset-3,.col-sm-offset-4,.col-sm-offset-5,.col-sm-offset-6,.col-sm-offset-7,.col-sm-offset-8,.col-sm-offset-9{box-sizing:border-box;-webkit-box-flex:0;-ms-flex:0 0 auto;flex:none;padding-right:.5rem;padding-left:.5rem}.col-sm{-webkit-box-flex:1;-ms-flex-positive:1;flex-grow:1;-ms-flex-preferred-size:0;flex-basis:0;max-width:100%}.col-sm-1{-ms-flex-preferred-size:8.33333333%;flex-basis:8.33333333%;max-width:8.33333333%}.col-sm-2{-ms-flex-preferred-size:16.66666667%;flex-basis:16.66666667%;max-width:16.66666667%}.col-sm-3{-ms-flex-preferred-size:25%;flex-basis:25%;max-width:25%}.col-sm-4{-ms-flex-preferred-size:33.33333333%;flex-basis:33.33333333%;max-width:33.33333333%}.col-sm-5{-ms-flex-preferred-size:41.66666667%;flex-basis:41.66666667%;max-width:41.66666667%}.col-sm-6{-ms-flex-preferred-size:50%;flex-basis:50%;max-width:50%}.col-sm-7{-ms-flex-preferred-size:58.33333333%;flex-basis:58.33333333%;max-width:58.33333333%}.col-sm-8{-ms-flex-preferred-size:66.66666667%;flex-basis:66.66666667%;max-width:66.66666667%}.col-sm-9{-ms-flex-preferred-size:75%;flex-basis:75%;max-width:75%}.col-sm-10{-ms-flex-preferred-size:83.33333333%;flex-basis:83.33333333%;max-width:83.33333333%}.col-sm-11{-ms-flex-preferred-size:91.66666667%;flex-basis:91.66666667%;max-width:91.66666667%}.col-sm-12{-ms-flex-preferred-size:100%;flex-basis:100%;max-width:100%}.col-sm-offset-0{margin-left:0}.col-sm-offset-1{margin-left:8.33333333%}.col-sm-offset-2{margin-left:16.66666667%}.col-sm-offset-3{margin-left:25%}.col-sm-offset-4{margin-left:33.33333333%}.col-sm-offset-5{margin-left:41.66666667%}.col-sm-offset-6{margin-left:50%}.col-sm-offset-7{margin-left:58.33333333%}.col-sm-offset-8{margin-left:66.66666667%}.col-sm-offset-9{margin-left:75%}.col-sm-offset-10{margin-left:83.33333333%}.col-sm-offset-11{margin-left:91.66666667%}.start-sm{-webkit-box-pack:start;-ms-flex-pack:start;justify-content:flex-start;text-align:start}.center-sm{-webkit-box-pack:center;-ms-flex-pack:center;justify-content:center;text-align:center}.end-sm{-webkit-box-pack:end;-ms-flex-pack:end;justify-content:flex-end;text-align:end}.top-sm{-webkit-box-align:start;-ms-flex-align:start;align-items:flex-start}.middle-sm{-webkit-box-align:center;-ms-flex-align:center;align-items:center}.bottom-sm{-webkit-box-align:end;-ms-flex-align:end;align-items:flex-end}.around-sm{-ms-flex-pack:distribute;justify-content:space-around}.between-sm{-webkit-box-pack:justify;-ms-flex-pack:justify;justify-content:space-between}.first-sm{-webkit-box-ordinal-group:0;-ms-flex-order:-1;order:-1}.last-sm{-webkit-box-ordinal-group:2;-ms-flex-order:1;order:1}}@media only screen and (min-width:64em){.container{width:65rem}.col-md,.col-md-1,.col-md-10,.col-md-11,.col-md-12,.col-md-2,.col-md-3,.col-md-4,.col-md-5,.col-md-6,.col-md-7,.col-md-8,.col-md-9,.col-md-offset-0,.col-md-offset-1,.col-md-offset-10,.col-md-offset-11,.col-md-offset-12,.col-md-offset-2,.col-md-offset-3,.col-md-offset-4,.col-md-offset-5,.col-md-offset-6,.col-md-offset-7,.col-md-offset-8,.col-md-offset-9{box-sizing:border-box;-webkit-box-flex:0;-ms-flex:0 0 auto;flex:none;padding-right:.5rem;padding-left:.5rem}.col-md{-webkit-box-flex:1;-ms-flex-positive:1;flex-grow:1;-ms-flex-preferred-size:0;flex-basis:0;max-width:100%}.col-md-1{-ms-flex-preferred-size:8.33333333%;flex-basis:8.33333333%;max-width:8.33333333%}.col-md-2{-ms-flex-preferred-size:16.66666667%;flex-basis:16.66666667%;max-width:16.66666667%}.col-md-3{-ms-flex-preferred-size:25%;flex-basis:25%;max-width:25%}.col-md-4{-ms-flex-preferred-size:33.33333333%;flex-basis:33.33333333%;max-width:33.33333333%}.col-md-5{-ms-flex-preferred-size:41.66666667%;flex-basis:41.66666667%;max-width:41.66666667%}.col-md-6{-ms-flex-preferred-size:50%;flex-basis:50%;max-width:50%}.col-md-7{-ms-flex-preferred-size:58.33333333%;flex-basis:58.33333333%;max-width:58.33333333%}.col-md-8{-ms-flex-preferred-size:66.66666667%;flex-basis:66.66666667%;max-width:66.66666667%}.col-md-9{-ms-flex-preferred-size:75%;flex-basis:75%;max-width:75%}.col-md-10{-ms-flex-preferred-size:83.33333333%;flex-basis:83.33333333%;max-width:83.33333333%}.col-md-11{-ms-flex-preferred-size:91.66666667%;flex-basis:91.66666667%;max-width:91.66666667%}.col-md-12{-ms-flex-preferred-size:100%;flex-basis:100%;max-width:100%}.col-md-offset-0{margin-left:0}.col-md-offset-1{margin-left:8.33333333%}.col-md-offset-2{margin-left:16.66666667%}.col-md-offset-3{margin-left:25%}.col-md-offset-4{margin-left:33.33333333%}.col-md-offset-5{margin-left:41.66666667%}.col-md-offset-6{margin-left:50%}.col-md-offset-7{margin-left:58.33333333%}.col-md-offset-8{margin-left:66.66666667%}.col-md-offset-9{margin-left:75%}.col-md-offset-10{margin-left:83.33333333%}.col-md-offset-11{margin-left:91.66666667%}.start-md{-webkit-box-pack:start;-ms-flex-pack:start;justify-content:flex-start;text-align:start}.center-md{-webkit-box-pack:center;-ms-flex-pack:center;justify-content:center;text-align:center}.end-md{-webkit-box-pack:end;-ms-flex-pack:end;justify-content:flex-end;text-align:end}.top-md{-webkit-box-align:start;-ms-flex-align:start;align-items:flex-start}.middle-md{-webkit-box-align:center;-ms-flex-align:center;align-items:center}.bottom-md{-webkit-box-align:end;-ms-flex-align:end;align-items:flex-end}.around-md{-ms-flex-pack:distribute;justify-content:space-around}.between-md{-webkit-box-pack:justify;-ms-flex-pack:justify;justify-content:space-between}.first-md{-webkit-box-ordinal-group:0;-ms-flex-order:-1;order:-1}.last-md{-webkit-box-ordinal-group:2;-ms-flex-order:1;order:1}}@media only screen and (min-width:75em){.container{width:76rem}.col-lg,.col-lg-1,.col-lg-10,.col-lg-11,.col-lg-12,.col-lg-2,.col-lg-3,.col-lg-4,.col-lg-5,.col-lg-6,.col-lg-7,.col-lg-8,.col-lg-9,.col-lg-offset-0,.col-lg-offset-1,.col-lg-offset-10,.col-lg-offset-11,.col-lg-offset-12,.col-lg-offset-2,.col-lg-offset-3,.col-lg-offset-4,.col-lg-offset-5,.col-lg-offset-6,.col-lg-offset-7,.col-lg-offset-8,.col-lg-offset-9{box-sizing:border-box;-webkit-box-flex:0;-ms-flex:0 0 auto;flex:none;padding-right:.5rem;padding-left:.5rem}.col-lg{-webkit-box-flex:1;-ms-flex-positive:1;flex-grow:1;-ms-flex-preferred-size:0;flex-basis:0;max-width:100%}.col-lg-1{-ms-flex-preferred-size:8.33333333%;flex-basis:8.33333333%;max-width:8.33333333%}.col-lg-2{-ms-flex-preferred-size:16.66666667%;flex-basis:16.66666667%;max-width:16.66666667%}.col-lg-3{-ms-flex-preferred-size:25%;flex-basis:25%;max-width:25%}.col-lg-4{-ms-flex-preferred-size:33.33333333%;flex-basis:33.33333333%;max-width:33.33333333%}.col-lg-5{-ms-flex-preferred-size:41.66666667%;flex-basis:41.66666667%;max-width:41.66666667%}.col-lg-6{-ms-flex-preferred-size:50%;flex-basis:50%;max-width:50%}.col-lg-7{-ms-flex-preferred-size:58.33333333%;flex-basis:58.33333333%;max-width:58.33333333%}.col-lg-8{-ms-flex-preferred-size:66.66666667%;flex-basis:66.66666667%;max-width:66.66666667%}.col-lg-9{-ms-flex-preferred-size:75%;flex-basis:75%;max-width:75%}.col-lg-10{-ms-flex-preferred-size:83.33333333%;flex-basis:83.33333333%;max-width:83.33333333%}.col-lg-11{-ms-flex-preferred-size:91.66666667%;flex-basis:91.66666667%;max-width:91.66666667%}.col-lg-12{-ms-flex-preferred-size:100%;flex-basis:100%;max-width:100%}.col-lg-offset-0{margin-left:0}.col-lg-offset-1{margin-left:8.33333333%}.col-lg-offset-2{margin-left:16.66666667%}.col-lg-offset-3{margin-left:25%}.col-lg-offset-4{margin-left:33.33333333%}.col-lg-offset-5{margin-left:41.66666667%}.col-lg-offset-6{margin-left:50%}.col-lg-offset-7{margin-left:58.33333333%}.col-lg-offset-8{margin-left:66.66666667%}.col-lg-offset-9{margin-left:75%}.col-lg-offset-10{margin-left:83.33333333%}.col-lg-offset-11{margin-left:91.66666667%}.start-lg{-webkit-box-pack:start;-ms-flex-pack:start;justify-content:flex-start;text-align:start}.center-lg{-webkit-box-pack:center;-ms-flex-pack:center;justify-content:center;text-align:center}.end-lg{-webkit-box-pack:end;-ms-flex-pack:end;justify-content:flex-end;text-align:end}.top-lg{-webkit-box-align:start;-ms-flex-align:start;align-items:flex-start}.middle-lg{-webkit-box-align:center;-ms-flex-align:center;align-items:center}.bottom-lg{-webkit-box-align:end;-ms-flex-align:end;align-items:flex-end}.around-lg{-ms-flex-pack:distribute;justify-content:space-around}.between-lg{-webkit-box-pack:justify;-ms-flex-pack:justify;justify-content:space-between}.first-lg{-webkit-box-ordinal-group:0;-ms-flex-order:-1;order:-1}.last-lg{-webkit-box-ordinal-group:2;-ms-flex-order:1;order:1}}</style><link rel=stylesheet href=/css/background.css><link href=/index.xml rel=alternate type=application/rss+xml title="CattleHorse's Blog"><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/@callmebill/lxgw-wenkai-web@latest/lxgwwenkai-regular/result.css><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/firacode@6.2.0/distr/fira_code.min.css></head><body><article class="post Chinese" id=article><div class=row><div class=col-xs-12><div class=site-header><header><div class=header-title><a href=/>CattleHorse's Blog</a></div><div class=header-subtitle>By accumulating small steps, one can reach a thousand miles.</div></header><div class="row end-md header-items"><div class=header-item><a href=/index.xml target=_blank>RSS</a></div><div class=header-item><a href=https://github.com/cattle0horse target=_blank>Github</a></div></div><div class=row></div><div class=header-line></div></div><header class=post-header><h1 class=post-title>限流初识</h1><div class="row post-desc"><div class=col-xs-6><time class=post-date datetime="2025-07-10 00:00:00 UTC">2025.07.10</time></div><div class=col-xs-6></div></div></header><div class="post-content markdown-body"><h2 id=为什么需要限流>为什么需要限流</h2><h3 id=避免连锁崩溃>避免连锁崩溃</h3><p>一个服务即便进行过压测，但当真实运行到线上时，其收到的请求流量以及能够负载的流量是不固定的，如果服务自身没有一个自我保护机制，当流量超过预计的负载后，会将这部分负载传递给该服务的下游，造成连锁反应甚至雪崩。</p><h3 id=提供可靠的响应时间>提供可靠的响应时间</h3><p>服务调用方一般都设有超时时间，如果一个服务由于拥塞，导致响应时间都处于超时状态，那么即便服务最终正确提供了响应，对于 Client 来说也完全没有意义。</p><p>一个服务对于调用方提供的承诺既包含了响应的结果，也包含了响应的时间。限流能够让服务自身通过主动丢弃负载能力外的流量，以达到在额定负载能力下，依然能够维持有效的响应效率。</p><h2 id=限流方案>限流方案</h2><h3 id=固定窗口计数器fixed-window-counter>固定窗口计数器（Fixed Window Counter）</h3><ul><li><strong>原理</strong>：在固定的时间窗口内，允许一定数量的请求通过。每当时间窗口结束时，计数器会重置。超出最大请求数的请求将被拒绝。</li><li><strong>特点</strong>：</li><li>容易受到时间窗口边界问题的影响（即在窗口切换时，可能会允许过多的请求通过）</li><li><strong>适用场景</strong>：适用于流量相对平稳的场景，通常在请求量较低的应用中使用。</li></ul><p><img src=/posts/rate-limiter/attachments/%E9%99%90%E6%B5%81-20250518142232339.png alt></p><p>具体来说，当大量请求在一个窗口的特别早或特别晚时，就会出现“突刺”现象。太早则窗口剩余时间无法处理；太晚则可能和下一个窗口的大量请求堆积，导致超出阈值。</p><p>例如在 1 分钟内，5 个请求都是在前 30s 过来的，那么后面的 30s 的请求都会被拒绝，而系统此时是空闲的。另外还有“临界问题”，如果 5 个请求是在后 30s 过来的，而下一个 1 分钟的 5 个请求在前 30s 过来，此时系统在这 1 分钟内就需要处理 200 个请求，跟我们想要的不符合。</p><p><img src=/posts/rate-limiter/attachments/%E9%99%90%E6%B5%81-20250518142042844.png alt></p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#204a87;font-weight:700>type</span> <span style=color:#000>FixedWindowCounter</span> <span style=color:#204a87;font-weight:700>struct</span> <span style=color:#000;font-weight:700>{</span>
</span></span><span style=display:flex><span>    <span style=color:#000>mu</span>        <span style=color:#000>sync</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>Mutex</span>
</span></span><span style=display:flex><span>    <span style=color:#000>requestCount</span> <span style=color:#204a87;font-weight:700>int</span>
</span></span><span style=display:flex><span>    <span style=color:#000>limit</span>     <span style=color:#204a87;font-weight:700>int</span>
</span></span><span style=display:flex><span>    <span style=color:#000>window</span>    <span style=color:#000>time</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>Duration</span>
</span></span><span style=display:flex><span>    <span style=color:#000>resetTime</span> <span style=color:#000>time</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>Time</span>
</span></span><span style=display:flex><span><span style=color:#000;font-weight:700>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>func</span> <span style=color:#000>NewFixedWindowCounter</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>limit</span> <span style=color:#204a87;font-weight:700>int</span><span style=color:#000;font-weight:700>,</span> <span style=color:#000>window</span> <span style=color:#000>time</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>Duration</span><span style=color:#000;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>*</span><span style=color:#000>FixedWindowCounter</span> <span style=color:#000;font-weight:700>{</span>
</span></span><span style=display:flex><span>    <span style=color:#204a87;font-weight:700>return</span> <span style=color:#ce5c00;font-weight:700>&amp;</span><span style=color:#000>FixedWindowCounter</span><span style=color:#000;font-weight:700>{</span>
</span></span><span style=display:flex><span>        <span style=color:#000>limit</span><span style=color:#000;font-weight:700>:</span> <span style=color:#000>limit</span><span style=color:#000;font-weight:700>,</span>
</span></span><span style=display:flex><span>        <span style=color:#000>window</span><span style=color:#000;font-weight:700>:</span> <span style=color:#000>window</span><span style=color:#000;font-weight:700>,</span>
</span></span><span style=display:flex><span>        <span style=color:#000>resetTime</span><span style=color:#000;font-weight:700>:</span> <span style=color:#000>time</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>Now</span><span style=color:#000;font-weight:700>(),</span>
</span></span><span style=display:flex><span>    <span style=color:#000;font-weight:700>}</span>
</span></span><span style=display:flex><span><span style=color:#000;font-weight:700>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>func</span> <span style=color:#000;font-weight:700>(</span><span style=color:#000>fw</span> <span style=color:#ce5c00;font-weight:700>*</span><span style=color:#000>FixedWindowCounter</span><span style=color:#000;font-weight:700>)</span> <span style=color:#000>Allow</span><span style=color:#000;font-weight:700>()</span> <span style=color:#204a87;font-weight:700>bool</span> <span style=color:#000;font-weight:700>{</span>
</span></span><span style=display:flex><span>    <span style=color:#000>fw</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>mu</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>Lock</span><span style=color:#000;font-weight:700>()</span>
</span></span><span style=display:flex><span>    <span style=color:#204a87;font-weight:700>defer</span> <span style=color:#000>fw</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>mu</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>Unlock</span><span style=color:#000;font-weight:700>()</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#000>now</span> <span style=color:#ce5c00;font-weight:700>:=</span> <span style=color:#000>time</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>Now</span><span style=color:#000;font-weight:700>()</span>
</span></span><span style=display:flex><span>    <span style=color:#8f5902;font-style:italic>// 如果距离上次重置时间大于窗口值，则重置计数器</span>
</span></span><span style=display:flex><span>    <span style=color:#204a87;font-weight:700>if</span> <span style=color:#000>now</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>Sub</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>fw</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>resetTime</span><span style=color:#000;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>&gt;=</span> <span style=color:#000>fw</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>window</span> <span style=color:#000;font-weight:700>{</span>
</span></span><span style=display:flex><span>        <span style=color:#000>fw</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>requestCount</span> <span style=color:#000;font-weight:700>=</span> <span style=color:#0000cf;font-weight:700>0</span>
</span></span><span style=display:flex><span>        <span style=color:#000>fw</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>resetTime</span> <span style=color:#000;font-weight:700>=</span> <span style=color:#000>now</span>
</span></span><span style=display:flex><span>    <span style=color:#000;font-weight:700>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#204a87;font-weight:700>if</span> <span style=color:#000>fw</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>requestCount</span> <span style=color:#000;font-weight:700>&lt;</span> <span style=color:#000>fw</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>limit</span> <span style=color:#000;font-weight:700>{</span>
</span></span><span style=display:flex><span>        <span style=color:#000>fw</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>requestCount</span><span style=color:#ce5c00;font-weight:700>++</span>
</span></span><span style=display:flex><span>        <span style=color:#204a87;font-weight:700>return</span> <span style=color:#204a87;font-weight:700>true</span>
</span></span><span style=display:flex><span>    <span style=color:#000;font-weight:700>}</span>
</span></span><span style=display:flex><span>    <span style=color:#204a87;font-weight:700>return</span> <span style=color:#204a87;font-weight:700>false</span>
</span></span><span style=display:flex><span><span style=color:#000;font-weight:700>}</span>
</span></span></code></pre></div><h3 id=滑动窗口日志sliding-window-log>滑动窗口日志（Sliding Window Log）</h3><ul><li><strong>原理</strong>：每次请求都会在时间轴上记录，滑动窗口会随着时间的推移进行更新。</li><li><strong>特点</strong>：<ul><li>能够更加平滑地控制请求速率，避免固定窗口切换时的突发流量</li><li>其消耗的内存过多，因为即使一个请求已被拒绝，它的时间戳依然被保存在内存中。</li></ul></li><li><strong>适用场景</strong>：适用于需要精确限流的场景，减少边界效应。</li></ul><p><img src=/posts/rate-limiter/attachments/%E9%99%90%E6%B5%81-20250518170443499.png alt></p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#204a87;font-weight:700>type</span> <span style=color:#000>SlidingWindowLog</span> <span style=color:#204a87;font-weight:700>struct</span> <span style=color:#000;font-weight:700>{</span>
</span></span><span style=display:flex><span>    <span style=color:#000>mu</span>        <span style=color:#000>sync</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>Mutex</span>
</span></span><span style=display:flex><span>    <span style=color:#000>events</span>    <span style=color:#ce5c00;font-weight:700>*</span><span style=color:#000>list</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>List</span> <span style=color:#8f5902;font-style:italic>// 双向链表</span>
</span></span><span style=display:flex><span>    <span style=color:#000>limit</span>     <span style=color:#204a87;font-weight:700>int</span>
</span></span><span style=display:flex><span>    <span style=color:#000>window</span>    <span style=color:#000>time</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>Duration</span>
</span></span><span style=display:flex><span><span style=color:#000;font-weight:700>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>func</span> <span style=color:#000>NewSlidingWindowLog</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>limit</span> <span style=color:#204a87;font-weight:700>int</span><span style=color:#000;font-weight:700>,</span> <span style=color:#000>window</span> <span style=color:#000>time</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>Duration</span><span style=color:#000;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>*</span><span style=color:#000>SlidingWindowLog</span> <span style=color:#000;font-weight:700>{</span>
</span></span><span style=display:flex><span>    <span style=color:#204a87;font-weight:700>return</span> <span style=color:#ce5c00;font-weight:700>&amp;</span><span style=color:#000>SlidingWindowLog</span><span style=color:#000;font-weight:700>{</span>
</span></span><span style=display:flex><span>        <span style=color:#000>events</span><span style=color:#000;font-weight:700>:</span> <span style=color:#000>list</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>New</span><span style=color:#000;font-weight:700>(),</span>
</span></span><span style=display:flex><span>        <span style=color:#000>limit</span><span style=color:#000;font-weight:700>:</span> <span style=color:#000>limit</span><span style=color:#000;font-weight:700>,</span>
</span></span><span style=display:flex><span>        <span style=color:#000>window</span><span style=color:#000;font-weight:700>:</span> <span style=color:#000>window</span><span style=color:#000;font-weight:700>,</span>
</span></span><span style=display:flex><span>    <span style=color:#000;font-weight:700>}</span>
</span></span><span style=display:flex><span><span style=color:#000;font-weight:700>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>func</span> <span style=color:#000;font-weight:700>(</span><span style=color:#000>sw</span> <span style=color:#ce5c00;font-weight:700>*</span><span style=color:#000>SlidingWindowLog</span><span style=color:#000;font-weight:700>)</span> <span style=color:#000>Allow</span><span style=color:#000;font-weight:700>()</span> <span style=color:#204a87;font-weight:700>bool</span> <span style=color:#000;font-weight:700>{</span>
</span></span><span style=display:flex><span>    <span style=color:#000>sw</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>mu</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>Lock</span><span style=color:#000;font-weight:700>()</span>
</span></span><span style=display:flex><span>    <span style=color:#204a87;font-weight:700>defer</span> <span style=color:#000>sw</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>mu</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>Unlock</span><span style=color:#000;font-weight:700>()</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#000>now</span> <span style=color:#ce5c00;font-weight:700>:=</span> <span style=color:#000>time</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>Now</span><span style=color:#000;font-weight:700>()</span>
</span></span><span style=display:flex><span>    <span style=color:#8f5902;font-style:italic>// 清理过期的事件</span>
</span></span><span style=display:flex><span>    <span style=color:#204a87;font-weight:700>for</span> <span style=color:#000>sw</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>events</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>Len</span><span style=color:#000;font-weight:700>()</span> <span style=color:#000;font-weight:700>&gt;</span> <span style=color:#0000cf;font-weight:700>0</span> <span style=color:#000;font-weight:700>{</span>
</span></span><span style=display:flex><span>		<span style=color:#8f5902;font-style:italic>// 最早的请求超过了窗口则删除</span>
</span></span><span style=display:flex><span>        <span style=color:#204a87;font-weight:700>if</span> <span style=color:#000>sw</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>events</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>Front</span><span style=color:#000;font-weight:700>().</span><span style=color:#000>Value</span><span style=color:#000;font-weight:700>.(</span><span style=color:#000>time</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>Time</span><span style=color:#000;font-weight:700>).</span><span style=color:#000>Add</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>sw</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>window</span><span style=color:#000;font-weight:700>).</span><span style=color:#000>Before</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>now</span><span style=color:#000;font-weight:700>)</span> <span style=color:#000;font-weight:700>{</span>
</span></span><span style=display:flex><span>            <span style=color:#000>sw</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>events</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>Remove</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>sw</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>events</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>Front</span><span style=color:#000;font-weight:700>())</span>
</span></span><span style=display:flex><span>        <span style=color:#000;font-weight:700>}</span> <span style=color:#204a87;font-weight:700>else</span> <span style=color:#000;font-weight:700>{</span>
</span></span><span style=display:flex><span>            <span style=color:#204a87;font-weight:700>break</span>
</span></span><span style=display:flex><span>        <span style=color:#000;font-weight:700>}</span>
</span></span><span style=display:flex><span>    <span style=color:#000;font-weight:700>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#204a87;font-weight:700>if</span> <span style=color:#000>sw</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>events</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>Len</span><span style=color:#000;font-weight:700>()</span> <span style=color:#000;font-weight:700>&lt;</span> <span style=color:#000>sw</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>limit</span> <span style=color:#000;font-weight:700>{</span>
</span></span><span style=display:flex><span>        <span style=color:#000>sw</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>events</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>PushBack</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>now</span><span style=color:#000;font-weight:700>)</span>
</span></span><span style=display:flex><span>        <span style=color:#204a87;font-weight:700>return</span> <span style=color:#204a87;font-weight:700>true</span>
</span></span><span style=display:flex><span>    <span style=color:#000;font-weight:700>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#204a87;font-weight:700>return</span> <span style=color:#204a87;font-weight:700>false</span>
</span></span><span style=display:flex><span><span style=color:#000;font-weight:700>}</span>
</span></span></code></pre></div><h3 id=滑动窗口计数器sliding-window-counter>滑动窗口计数器（Sliding Window Counter）</h3><ul><li><strong>原理</strong>：在滑动窗口日志的基础上进行修改，其中一种实现是「滑动窗口所允许的请求数量 = 当前窗口的请求数 + 之前窗口的请求数 × 滑动窗口和之前窗口的重合率」</li><li><strong>特点</strong>：<ul><li>它平滑了流量中的波动，因为当前时间窗口内请求的速率是基于前一个时间窗口内请求的平均速率计算出来的。</li><li>减少了记录大量时间戳的内存消耗</li><li>滑动窗口计数器算法的缺点是，它只对不那么严格的回溯窗口起作用。该算法只是对真实流量速率进行了近似估计，因为它假设前一个窗口中的请求是均匀分布的。尽管如此，这个问题可能并没有看起来那么严重。根据 Cloudflare 的实验，在 4 亿个请求中，只有 0.003% 的请求被错误地允许通过或被限流。</li></ul></li><li><strong>适用场景</strong>：同滑动窗口日志</li></ul><p><img src=/posts/rate-limiter/attachments/%E9%99%90%E6%B5%81-20250518151617824.png alt></p><h3 id=漏桶leaky-bucket>漏桶（Leaky Bucket）</h3><ul><li><strong>原理</strong>：类似于消息队列，使用一个桶来存储请求，当请求到达时，它们会依次进入桶中。如果桶没有满，水会以恒定的速率流出。如果桶已满，则新请求会被丢弃。</li><li><strong>特点</strong>：<ul><li>平滑的流量控制，能确保请求按照固定速率流出。</li><li>不允许短时间内出现突发流量，所有的请求流量按固定速率流出。</li></ul></li><li><strong>适用场景</strong>：适用于需要平滑流量、避免短时间内的突发请求影响系统的场景。</li></ul><p><img src=/posts/rate-limiter/attachments/%E9%99%90%E6%B5%81-20250518152439885.png alt></p><p>在实现时，并不一定需要真的存储请求，只需要记录「目前可用令牌数量」和「上一次访问时间」，当请求时，根据这两个变量计算出这个过程中的漏出的水的数量即可</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#204a87;font-weight:700>type</span> <span style=color:#000>LeakyBucket</span> <span style=color:#204a87;font-weight:700>struct</span> <span style=color:#000;font-weight:700>{</span>
</span></span><span style=display:flex><span>	<span style=color:#000>mu</span>       <span style=color:#000>sync</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>Mutex</span>
</span></span><span style=display:flex><span>	<span style=color:#000>capacity</span> <span style=color:#204a87;font-weight:700>int</span>
</span></span><span style=display:flex><span>	<span style=color:#000>water</span>    <span style=color:#204a87;font-weight:700>int</span>           <span style=color:#8f5902;font-style:italic>// 当前水量</span>
</span></span><span style=display:flex><span>	<span style=color:#000>rate</span>     <span style=color:#000>time</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>Duration</span> <span style=color:#8f5902;font-style:italic>// 漏水速度</span>
</span></span><span style=display:flex><span>	<span style=color:#000>lastTime</span> <span style=color:#000>time</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>Time</span>
</span></span><span style=display:flex><span><span style=color:#000;font-weight:700>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>func</span> <span style=color:#000>NewLeakyBucket</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>capacity</span> <span style=color:#204a87;font-weight:700>int</span><span style=color:#000;font-weight:700>,</span> <span style=color:#000>rate</span> <span style=color:#000>time</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>Duration</span><span style=color:#000;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>*</span><span style=color:#000>LeakyBucket</span> <span style=color:#000;font-weight:700>{</span>
</span></span><span style=display:flex><span>	<span style=color:#204a87;font-weight:700>return</span> <span style=color:#ce5c00;font-weight:700>&amp;</span><span style=color:#000>LeakyBucket</span><span style=color:#000;font-weight:700>{</span>
</span></span><span style=display:flex><span>		<span style=color:#000>capacity</span><span style=color:#000;font-weight:700>:</span> <span style=color:#000>capacity</span><span style=color:#000;font-weight:700>,</span>
</span></span><span style=display:flex><span>		<span style=color:#000>water</span><span style=color:#000;font-weight:700>:</span>    <span style=color:#0000cf;font-weight:700>0</span><span style=color:#000;font-weight:700>,</span>
</span></span><span style=display:flex><span>		<span style=color:#000>rate</span><span style=color:#000;font-weight:700>:</span>     <span style=color:#000>rate</span><span style=color:#000;font-weight:700>,</span>
</span></span><span style=display:flex><span>		<span style=color:#000>lastTime</span><span style=color:#000;font-weight:700>:</span> <span style=color:#000>time</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>Now</span><span style=color:#000;font-weight:700>(),</span>
</span></span><span style=display:flex><span>	<span style=color:#000;font-weight:700>}</span>
</span></span><span style=display:flex><span><span style=color:#000;font-weight:700>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>func</span> <span style=color:#000;font-weight:700>(</span><span style=color:#000>lb</span> <span style=color:#ce5c00;font-weight:700>*</span><span style=color:#000>LeakyBucket</span><span style=color:#000;font-weight:700>)</span> <span style=color:#000>Allow</span><span style=color:#000;font-weight:700>()</span> <span style=color:#204a87;font-weight:700>bool</span> <span style=color:#000;font-weight:700>{</span>
</span></span><span style=display:flex><span>	<span style=color:#000>lb</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>mu</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>Lock</span><span style=color:#000;font-weight:700>()</span>
</span></span><span style=display:flex><span>	<span style=color:#204a87;font-weight:700>defer</span> <span style=color:#000>lb</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>mu</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>Unlock</span><span style=color:#000;font-weight:700>()</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#000>now</span> <span style=color:#ce5c00;font-weight:700>:=</span> <span style=color:#000>time</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>Now</span><span style=color:#000;font-weight:700>()</span>
</span></span><span style=display:flex><span>	<span style=color:#000>elapsed</span> <span style=color:#ce5c00;font-weight:700>:=</span> <span style=color:#000>now</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>Sub</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>lb</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>lastTime</span><span style=color:#000;font-weight:700>)</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#8f5902;font-style:italic>// 计算两次请求之间漏的水的数量</span>
</span></span><span style=display:flex><span>	<span style=color:#000>lb</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>water</span> <span style=color:#000;font-weight:700>=</span> <span style=color:#204a87>max</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>lb</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>water</span><span style=color:#ce5c00;font-weight:700>-</span><span style=color:#204a87>int</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>elapsed</span><span style=color:#ce5c00;font-weight:700>/</span><span style=color:#000>lb</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>rate</span><span style=color:#000;font-weight:700>),</span> <span style=color:#0000cf;font-weight:700>0</span><span style=color:#000;font-weight:700>)</span>
</span></span><span style=display:flex><span>	<span style=color:#000>lb</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>lastTime</span> <span style=color:#000;font-weight:700>=</span> <span style=color:#000>now</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#8f5902;font-style:italic>// 如果可以继续加水，则返回 true</span>
</span></span><span style=display:flex><span>	<span style=color:#204a87;font-weight:700>if</span> <span style=color:#000>lb</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>water</span> <span style=color:#000;font-weight:700>&lt;</span> <span style=color:#000>lb</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>capacity</span> <span style=color:#000;font-weight:700>{</span>
</span></span><span style=display:flex><span>		<span style=color:#000>lb</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>water</span><span style=color:#ce5c00;font-weight:700>++</span>
</span></span><span style=display:flex><span>		<span style=color:#204a87;font-weight:700>return</span> <span style=color:#204a87;font-weight:700>true</span>
</span></span><span style=display:flex><span>	<span style=color:#000;font-weight:700>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#204a87;font-weight:700>return</span> <span style=color:#204a87;font-weight:700>false</span>
</span></span><span style=display:flex><span><span style=color:#000;font-weight:700>}</span>
</span></span></code></pre></div><h3 id=令牌桶token-bucket>令牌桶（Token Bucket）</h3><ul><li><strong>原理</strong>：每个请求需要获取一个令牌。令牌会<strong>以固定速率放入桶</strong>中，<strong>桶有最大容量</strong>。如果桶满了，新的令牌将会丢弃。当请求到达时，若桶中有令牌，说明可以处理该请求，令牌被取走；若桶中没有令牌，则拒绝请求。</li><li><strong>特点</strong>：<ul><li>能够处理突发流量，因为桶中可以积累一定数量的令牌。</li><li>适用于允许请求量有一定波动的场景。</li></ul></li><li><strong>适用场景</strong>：适用于限流场景中需要允许短时间内的流量突增，例如某些高并发的 API 服务。</li></ul><p><img src=/posts/rate-limiter/attachments/%E9%99%90%E6%B5%81-20250518152849703.png alt></p><p>与漏桶类似，并不一定需要真的存储请求，只需要记录「目前可用令牌数量」和「上一次访问时间」，当请求时，根据这两个变量计算出这个过程中的增长的令牌数量即可</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#204a87;font-weight:700>type</span> <span style=color:#000>TokenBucket</span> <span style=color:#204a87;font-weight:700>struct</span> <span style=color:#000;font-weight:700>{</span>
</span></span><span style=display:flex><span>	<span style=color:#000>mu</span>       <span style=color:#000>sync</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>Mutex</span>
</span></span><span style=display:flex><span>	<span style=color:#000>capacity</span> <span style=color:#204a87;font-weight:700>int</span>
</span></span><span style=display:flex><span>	<span style=color:#000>tokens</span>   <span style=color:#204a87;font-weight:700>int</span>           <span style=color:#8f5902;font-style:italic>// 当前可用令牌数</span>
</span></span><span style=display:flex><span>	<span style=color:#000>rate</span>     <span style=color:#000>time</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>Duration</span> <span style=color:#8f5902;font-style:italic>// 令牌发放速度</span>
</span></span><span style=display:flex><span>	<span style=color:#000>lastTime</span> <span style=color:#000>time</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>Time</span>     <span style=color:#8f5902;font-style:italic>// 上一次请求时间</span>
</span></span><span style=display:flex><span><span style=color:#000;font-weight:700>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>func</span> <span style=color:#000>NewTokenBucket</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>capacity</span> <span style=color:#204a87;font-weight:700>int</span><span style=color:#000;font-weight:700>,</span> <span style=color:#000>rate</span> <span style=color:#000>time</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>Duration</span><span style=color:#000;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>*</span><span style=color:#000>TokenBucket</span> <span style=color:#000;font-weight:700>{</span>
</span></span><span style=display:flex><span>	<span style=color:#204a87;font-weight:700>return</span> <span style=color:#ce5c00;font-weight:700>&amp;</span><span style=color:#000>TokenBucket</span><span style=color:#000;font-weight:700>{</span>
</span></span><span style=display:flex><span>		<span style=color:#000>capacity</span><span style=color:#000;font-weight:700>:</span> <span style=color:#000>capacity</span><span style=color:#000;font-weight:700>,</span>
</span></span><span style=display:flex><span>		<span style=color:#000>tokens</span><span style=color:#000;font-weight:700>:</span>   <span style=color:#000>capacity</span><span style=color:#000;font-weight:700>,</span>
</span></span><span style=display:flex><span>		<span style=color:#000>rate</span><span style=color:#000;font-weight:700>:</span>     <span style=color:#000>rate</span><span style=color:#000;font-weight:700>,</span>
</span></span><span style=display:flex><span>		<span style=color:#000>lastTime</span><span style=color:#000;font-weight:700>:</span> <span style=color:#000>time</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>Now</span><span style=color:#000;font-weight:700>(),</span>
</span></span><span style=display:flex><span>	<span style=color:#000;font-weight:700>}</span>
</span></span><span style=display:flex><span><span style=color:#000;font-weight:700>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>func</span> <span style=color:#000;font-weight:700>(</span><span style=color:#000>tb</span> <span style=color:#ce5c00;font-weight:700>*</span><span style=color:#000>TokenBucket</span><span style=color:#000;font-weight:700>)</span> <span style=color:#000>Allow</span><span style=color:#000;font-weight:700>()</span> <span style=color:#204a87;font-weight:700>bool</span> <span style=color:#000;font-weight:700>{</span>
</span></span><span style=display:flex><span>	<span style=color:#000>tb</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>mu</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>Lock</span><span style=color:#000;font-weight:700>()</span>
</span></span><span style=display:flex><span>	<span style=color:#204a87;font-weight:700>defer</span> <span style=color:#000>tb</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>mu</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>Unlock</span><span style=color:#000;font-weight:700>()</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#000>now</span> <span style=color:#ce5c00;font-weight:700>:=</span> <span style=color:#000>time</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>Now</span><span style=color:#000;font-weight:700>()</span>
</span></span><span style=display:flex><span>	<span style=color:#000>elapsed</span> <span style=color:#ce5c00;font-weight:700>:=</span> <span style=color:#000>now</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>Sub</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>tb</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>lastTime</span><span style=color:#000;font-weight:700>)</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#8f5902;font-style:italic>// 计算当前可用令牌数</span>
</span></span><span style=display:flex><span>	<span style=color:#000>tb</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>tokens</span> <span style=color:#000;font-weight:700>=</span> <span style=color:#204a87>min</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>tb</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>tokens</span><span style=color:#ce5c00;font-weight:700>+</span><span style=color:#204a87>int</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>elapsed</span><span style=color:#ce5c00;font-weight:700>/</span><span style=color:#000>tb</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>rate</span><span style=color:#000;font-weight:700>),</span> <span style=color:#000>tb</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>capacity</span><span style=color:#000;font-weight:700>)</span>
</span></span><span style=display:flex><span>	<span style=color:#000>tb</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>lastTime</span> <span style=color:#000;font-weight:700>=</span> <span style=color:#000>now</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#8f5902;font-style:italic>// 如果有令牌，则允许访问，并扣除一个令牌</span>
</span></span><span style=display:flex><span>	<span style=color:#204a87;font-weight:700>if</span> <span style=color:#000>tb</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>tokens</span> <span style=color:#000;font-weight:700>&gt;</span> <span style=color:#0000cf;font-weight:700>0</span> <span style=color:#000;font-weight:700>{</span>
</span></span><span style=display:flex><span>		<span style=color:#000>tb</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>tokens</span><span style=color:#ce5c00;font-weight:700>--</span>
</span></span><span style=display:flex><span>		<span style=color:#204a87;font-weight:700>return</span> <span style=color:#204a87;font-weight:700>true</span>
</span></span><span style=display:flex><span>	<span style=color:#000;font-weight:700>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#204a87;font-weight:700>return</span> <span style=color:#204a87;font-weight:700>false</span>
</span></span><span style=display:flex><span><span style=color:#000;font-weight:700>}</span>
</span></span></code></pre></div><h2 id=参考>参考</h2><ul><li><a href=https://blog.joway.io/posts/deep-into-rpc-ratelimiter/>RPC 漫谈： 限流问题 - joway</a></li></ul></div><div class="row middle-xs"><div class=col-xs-12><div class=post-tags><a href=/tags/%E7%B3%BB%E7%BB%9F%E8%AE%BE%E8%AE%A1/>系统设计</a></div></div></div><div class=row><div class=col-xs-12></div></div><div style=height:50px></div><div class=site-footer></div></div></div></article><script src=/js/lazyload.min.js></script><script>var lazyImage=new LazyLoad({container:document.getElementById("article")})</script></body></html>